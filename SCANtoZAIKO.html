<SCANtoZAIKO html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>バーコード入出庫管理</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, input, button { margin: 5px; padding: 8px; }
    #reader { width: 300px; margin-top: 10px; }
    #result { white-space: pre-wrap; margin-top: 10px; background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <h2>バーコード入出庫管理</h2>

  <label>処理種別:</label>
  <select id="action">
    <option value="入庫">入庫</option>
    <option value="出庫">出庫</option>
  </select><br>

  <label>数量:</label>
  <input type="number" id="quantity" value="1" min="1"><br>

  <label>登録者:</label>
  <select id="operator">
    <option value="">選択してください</option>
    <option value="山田">山田</option>
    <option value="佐藤">佐藤</option>
  </select><br>

  <label>担当者:</label>
  <select id="consumer">
    <option value="">選択してください</option>
    <option value="田中">田中</option>
    <option value="鈴木">鈴木</option>
  </select><br>

  <button onclick="startScanner()">📷 スキャン開始</button>
  <button onclick="stopScanner()">🛑 スキャン停止</button>
  <button onclick="submitData()">📤 送信</button>
  <button onclick="resetForm()">終了</button>

  <div id="reader"></div>
  <div id="result">読み取り結果がここに表示されます</div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbynFMOKoIa4s2W2AODyrwZ4C0ISWer7JqUjgRT2tB78OwC25_TWvPI1xX32LPnjuec2LA/exec"; // ← Google Apps ScriptのURLに置き換えてください
    let html5QrCode;
    let scannedBarcode = "";

    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decodedText => {
          scannedBarcode = decodedText;
          document.getElementById("result").textContent = `バーコード: ${decodedText}`;
          html5QrCode.stop();
        },
        error => { console.log("スキャン失敗:", error); }
      ).catch(err => {
        document.getElementById("result").textContent = `スキャンエラー:\n${err}`;
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
        }).catch(err => {
          console.error("停止エラー:", err);
        });
      }
    }

    function submitData() {
      const type = document.getElementById("action").value;
      const qty = document.getElementById("quantity").value;
      const operator = document.getElementById("operator").value;
      const consumer = document.getElementById("consumer").value;

      if (!scannedBarcode) {
        alert("バーコードが未スキャンです");
        return;
      }
      if (!operator || !consumer) {
        alert("登録者と担当者を選択してください");
        return;
      }

      const body = `barcode=${encodeURIComponent(scannedBarcode)}&type=${encodeURIComponent(type)}&qty=${encodeURIComponent(qty)}&operator=${encodeURIComponent(operator)}&consumer=${encodeURIComponent(consumer)}`;

      fetch(scriptUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
      })
      .then(res => res.text())
      .then(text => {
        document.getElementById("result").textContent += `\n送信結果: ${text}`;
        scannedBarcode = ""; // 送信後にバーコードをクリア
      })
      .catch(err => {
        document.getElementById("result").textContent += `\n送信エラー:\n${err}`;
      });
    }

    function resetForm() {
      document.getElementById("action").value = "入庫";
      document.getElementById("quantity").value = 1;
      document.getElementById("operator").selectedIndex = 0;
      document.getElementById("consumer").selectedIndex = 0;
      document.getElementById("result").textContent = "読み取り結果がここに表示されます";
      scannedBarcode = "";
      stopScanner();
    }
  </script>
</body>
</html>

