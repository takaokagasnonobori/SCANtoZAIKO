<SCANtoZAIKO html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åœ¨åº«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2em;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 1em auto;
    }
    label, select, input {
      font-size: 1.2em;
      margin: 0.5em;
    }
    button {
      font-size: 1.5em;
      padding: 0.8em 1.5em;
      margin: 1em;
    }
    #result {
      font-size: 1.2em;
      margin-top: 1em;
      color: green;
      white-space: pre-wrap;
    }
  </style>
  <!-- âœ… Googleç¿»è¨³ãªã©å¤–éƒ¨CSSã¯èª­ã¿è¾¼ã¾ãªã„ -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>åœ¨åº«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h2>

  <div>
    <label>å‡¦ç†ç¨®åˆ¥ï¼š</label>
    <select id="action" name="action">
      <option value="å…¥åº«">å…¥åº«</option>
      <option value="å‡ºåº«">å‡ºåº«</option>
    </select>
    <label>æ•°é‡ï¼š</label>
    <input type="number" id="quantity" name="quantity" min="1" value="1">
  </div>

  <div>
    <label>ç™»éŒ²è€…ï¼š</label>
    <select id="operator" name="operator"></select>
    <label>å‡ºåº«è€…ï¼š</label>
    <select id="consumer" name="consumer"></select>
  </div>

  <div id="reader"></div>
  <button onclick="startScanner()" id="scanBtn" disabled>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button onclick="stopScanner()">ğŸ›‘ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
  <button onclick="resetForm()">çµ‚äº†</button>

  <div id="result">èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwekHd8Nn8DbZ_Ns6BLXXfjgdl4P7X47GXWiFp37S-jnH0lijSIX5HpuJW-7sVW-O1x6Q/exec";
    const userListUrl = "https://script.google.com/macros/s/AKfycbwe1KWXT4glYCDhL2IoZ-W4tprl_lh_VJECsHrEfTt80bSl9VeXVIW82ob5EXcJEQf2Jg/exec";
    let html5QrCode;

    function loadUserLists() {
      fetch(userListUrl)
        .then(res => res.json())
        .then(data => {
          const operatorSel = document.getElementById("operator");
          const consumerSel = document.getElementById("consumer");

          data.operators.forEach((name, i) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            operatorSel.appendChild(opt);
            if (i === 0) operatorSel.value = name;
          });

          data.consumers.forEach((name, i) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            consumerSel.appendChild(opt);
            if (i === 0) consumerSel.value = name;
          });

          document.getElementById("scanBtn").disabled = false;
        })
        .catch(err => {
          document.getElementById("result").textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:\n${err}`;
        });
    }

    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decodedText => {
          document.getElementById("result").textContent = `ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${decodedText}`;
          sendToSheet(decodedText);
          html5QrCode.stop();
        },
        error => { console.log("ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—:", error); }
      ).catch(err => {
        document.getElementById("result").textContent = `ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:\n${err}`;
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("result").textContent = "ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢ã—ã¾ã—ãŸ";
        });
      }
    }

    function sendToSheet(barcode) {
      const type = document.getElementById("action").value;
      const qty = document.getElementById("quantity").value;
      const operator = document.getElementById("operator").value;
      const consumer = document.getElementById("consumer").value;

      const body = `barcode=${encodeURIComponent(barcode)}&type=${encodeURIComponent(type)}&qty=${encodeURIComponent(qty)}&operator=${encodeURIComponent(operator)}&consumer=${encodeURIComponent(consumer)}`;

      fetch(scriptUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
      })
      .then(res => res.text())
      .then(text => {
        document.getElementById("result").textContent += `\né€ä¿¡çµæœ: ${text}`;
      })
      .catch(err => {
        document.getElementById("result").textContent += `\né€ä¿¡ã‚¨ãƒ©ãƒ¼:\n${err}`;
      });
    }

    function resetForm() {
      document.getElementById("result").textContent = "èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
      document.getElementById("quantity").value = 1;
    }

    loadUserLists();
  </script>
</body>
</html>

