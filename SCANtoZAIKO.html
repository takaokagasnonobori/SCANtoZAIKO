<SCANtoZAIKO html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å…¥å‡ºåº«ç®¡ç†</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, input, button { margin: 5px; padding: 8px; }
    #reader { width: 300px; margin-top: 10px; }
    #result { white-space: pre-wrap; margin-top: 10px; background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <h2>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å…¥å‡ºåº«ç®¡ç†</h2>

  <label>å‡¦ç†ç¨®åˆ¥:</label>
  <select id="action">
    <option value="å…¥åº«">å…¥åº«</option>
    <option value="å‡ºåº«">å‡ºåº«</option>
  </select><br>

  <label>æ•°é‡:</label>
  <input type="number" id="quantity" value="1" min="1"><br>

  <label>ç™»éŒ²è€…:</label>
  <select id="operator">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="å±±ç”°">å±±ç”°</option>
    <option value="ä½è—¤">ä½è—¤</option>
  </select><br>

  <label>æ‹…å½“è€…:</label>
  <select id="consumer">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="ç”°ä¸­">ç”°ä¸­</option>
    <option value="éˆ´æœ¨">éˆ´æœ¨</option>
  </select><br>

  <button onclick="startScanner()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button onclick="stopScanner()">ğŸ›‘ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
  <button onclick="submitData()">ğŸ“¤ é€ä¿¡</button>
  <button onclick="resetForm()">çµ‚äº†</button>

  <div id="reader"></div>
  <div id="result">èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbynFMOKoIa4s2W2AODyrwZ4C0ISWer7JqUjgRT2tB78OwC25_TWvPI1xX32LPnjuec2LA/exec"; // â† Google Apps Scriptã®URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
    let html5QrCode;
    let scannedBarcode = "";

    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decodedText => {
          scannedBarcode = decodedText;
          document.getElementById("result").textContent = `ãƒãƒ¼ã‚³ãƒ¼ãƒ‰: ${decodedText}`;
          html5QrCode.stop();
        },
        error => { console.log("ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—:", error); }
      ).catch(err => {
        document.getElementById("result").textContent = `ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:\n${err}`;
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
        }).catch(err => {
          console.error("åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
        });
      }
    }

    function submitData() {
      const type = document.getElementById("action").value;
      const qty = document.getElementById("quantity").value;
      const operator = document.getElementById("operator").value;
      const consumer = document.getElementById("consumer").value;

      if (!scannedBarcode) {
        alert("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒæœªã‚¹ã‚­ãƒ£ãƒ³ã§ã™");
        return;
      }
      if (!operator || !consumer) {
        alert("ç™»éŒ²è€…ã¨æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      const body = `barcode=${encodeURIComponent(scannedBarcode)}&type=${encodeURIComponent(type)}&qty=${encodeURIComponent(qty)}&operator=${encodeURIComponent(operator)}&consumer=${encodeURIComponent(consumer)}`;

      fetch(scriptUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
      })
      .then(res => res.text())
      .then(text => {
        document.getElementById("result").textContent += `\né€ä¿¡çµæœ: ${text}`;
        scannedBarcode = ""; // é€ä¿¡å¾Œã«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      })
      .catch(err => {
        document.getElementById("result").textContent += `\né€ä¿¡ã‚¨ãƒ©ãƒ¼:\n${err}`;
      });
    }

    function resetForm() {
      document.getElementById("action").value = "å…¥åº«";
      document.getElementById("quantity").value = 1;
      document.getElementById("operator").selectedIndex = 0;
      document.getElementById("consumer").selectedIndex = 0;
      document.getElementById("result").textContent = "èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
      scannedBarcode = "";
      stopScanner();
    }
  </script>
</body>
</html>

